---
- name: Build backend AMI using Packer
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    terragrunt_key_dir: "{{ playbook_dir | dirname | dirname }}/terraform/nat_key/key"
    ami_output_dir: "{{ playbook_dir | dirname | dirname }}/modules/compute/asg/ami_ids"
    key_file_path: "{{ playbook_dir | dirname | dirname }}/modules/nat_key/key/server_key"
    packer_template: "backend.pkr.hcl"

    # Build tracking
    cleanup_done: false
    delete_done: false
    build_failed: false
    error_message: ""
    log_file_modified: false
    ami_deleted: false

    # Environment variables
    aws_region: "{{ lookup('env', 'aws_region') }}"
    backend_instance_type: "{{ lookup('env', 'backend_instance_type') }}"
    ssh_username: "{{ lookup('env', 'ssh_username') }}"
    ssh_interface: "{{ lookup('env', 'ssh_interface') }}"
    VPC_ID: "{{ lookup('env', 'VPC_ID') }}"
    SUBNET_ID: "{{ lookup('env', 'SUBNET_ID') }}"
    DB_HOST: "{{ lookup('env', 'DB_HOST') }}"
    DB_PORT: "{{ lookup('env', 'DB_PORT') }}"
    DB_USER: "{{ lookup('env', 'DB_USER') }}"
    DB_NAME: "{{ lookup('env', 'DB_NAME') }}"
    DB_PASSWORD: "{{ lookup('env', 'DB_PASSWORD') }}"
    RDS_SG_ID: "{{ lookup('env', 'RDS_SG_ID') }}"
    s3_ssm_cw_instance_profile_name: "{{ lookup('env', 's3_ssm_cw_instance_profile_name') }}"
    db_secret_name: "{{ lookup('env', 'db_secret_name') }}"
    bucket_name: "{{ lookup('env', 'bucket_name') }}"
    backend_ami_type: "{{ lookup('env', 'backend_ami_type') }}"
    backend_volume_type: "{{ lookup('env', 'backend_volume_type') }}"
    backend_volume_size: "{{ lookup('env', 'backend_volume_size') }}"
    backend_ami_name: "{{ lookup('env', 'backend_ami_name') }}"
    environment: "{{ lookup('env', 'environment') }}"

  pre_tasks:
    - name: Initialize Packer plugins
      ansible.builtin.command: packer init .
      args:
        chdir: "{{ playbook_dir }}"
      changed_when: false

    - name: Validate required environment variables
      ansible.builtin.assert:
        that:
          - VPC_ID | length > 0
          - SUBNET_ID | length > 0
          - DB_HOST | length > 0
          - DB_USER | length > 0
          - DB_PASSWORD | length > 0
          - RDS_SG_ID | length > 0
          - aws_region | length > 0
          - backend_instance_type | length > 0
        fail_msg: |
          âŒ Missing required environment variables:
          Required: VPC_ID, SUBNET_ID, DB_HOST, DB_USER, DB_PASSWORD, RDS_SG_ID, aws_region, backend_instance_type
          Please export these variables before running the playbook.
      register: env_validation
      failed_when: false

    - name: Display configuration
      ansible.builtin.debug:
        msg: |
          ğŸ”§ Configuration:
          VPC_ID: {{ VPC_ID }}
          SUBNET_ID: {{ SUBNET_ID }}
          DB_HOST: {{ DB_HOST }}
          DB_PORT: {{ DB_PORT }}
          RDS_SG_ID: {{ RDS_SG_ID }}
          Region: {{ aws_region }}

  tasks:
    - name: Ensure AMI output directory exists
      ansible.builtin.file:
        path: "{{ ami_output_dir }}"
        state: directory
        mode: "0755"
      changed_when: false

    - name: Create security group for Packer
      ansible.builtin.command: >
        aws ec2 create-security-group
        --group-name "packer-sg-{{ lookup('pipe', 'date +%s') }}"
        --description "Security group for Packer build {{ backend_ami_name }}"
        --vpc-id "{{ VPC_ID }}"
        --query 'GroupId'
        --output text
        --region "{{ aws_region }}"
      register: packer_sg
      changed_when: true
      retries: 3
      delay: 2
      until: packer_sg is succeeded

    - name: Set fact for PACKER_SG_ID
      ansible.builtin.set_fact:
        PACKER_SG_ID: "{{ packer_sg.stdout }}"

    - name: Add inbound SSH rule to Packer SG
      ansible.builtin.command: >
        aws ec2 authorize-security-group-ingress
        --group-id "{{ PACKER_SG_ID }}"
        --protocol tcp
        --port 22
        --cidr 0.0.0.0/0
        --region "{{ aws_region }}"
      changed_when: true
      retries: 3
      delay: 2
      until: result is succeeded
      ignore_errors: true

    - name: Allow Packer SG to access RDS (port 3306)
      ansible.builtin.command: >
        aws ec2 authorize-security-group-ingress
        --group-id "{{ RDS_SG_ID }}"
        --protocol tcp
        --port 3306
        --source-group "{{ PACKER_SG_ID }}"
        --region "{{ aws_region }}"
      changed_when: true
      retries: 3
      delay: 2
      until: result is succeeded
      ignore_errors: true

    - name: Get latest Amazon Linux 2023 AMI
      ansible.builtin.command: >
        aws ec2 describe-images
        --owners amazon
        --filters "Name=name,Values={{ backend_ami_type }}" "Name=state,Values=available"
        --query "sort_by(Images, &CreationDate)[-1].ImageId"
        --output text
        --region "{{ aws_region }}"
      register: SOURCE_AMI
      changed_when: false
      retries: 3
      delay: 2
      until: SOURCE_AMI.stdout | length > 0

    - name: Display selected source AMI
      debug:
        msg: "Using latest Amazon Linux 2023 AMI: {{ SOURCE_AMI.stdout }}"

    - name: Get server_key_name from Terraform output
      ansible.builtin.shell: >
        terragrunt --working-dir {{ terragrunt_key_dir }} output -raw server_key_name
      register: server_key_name
      changed_when: false
      retries: 3
      delay: 2
      until: server_key_name.stdout | length > 0

    - name: Display server_key_name value
      debug:
        msg: "The server key name is: {{ server_key_name.stdout }}"

    - name: Generate packer log file path
      ansible.builtin.shell: |
        LOG_DIR="packer-logs"
        mkdir -p "$LOG_DIR"

        # Find the highest existing number
        last_log=$(ls "$LOG_DIR"/*.log 2>/dev/null | sort -V | tail -n 1 || true)
        if [ -z "$last_log" ]; then
          next_num=0
        else
          last_num=$(basename "$last_log" .log | grep -oE '[0-9]+$' || echo 0)
          next_num=$((last_num + 1))
        fi

        LOG_FILE="$LOG_DIR/packerlognew${next_num}.log"
        echo "$LOG_FILE"
      register: log_file_name
      changed_when: false

    - name: Set packer log path
      ansible.builtin.set_fact:
        clean_packer_log_path: "{{ log_file_name.stdout | trim }}"

    - name: Display packer log path
      debug:
        msg: "ğŸ“‹ Packer logs will be saved to: {{ clean_packer_log_path }}"

    - name: Main Packer Build Block
      block:
        - name: Run packer build
          ansible.builtin.shell: |
            set -euo pipefail
            echo "Starting Packer build for Backend AMI..."
            PACKER_LOG=1 PACKER_LOG_PATH={{ clean_packer_log_path }} packer build \
              -var "aws_region={{ aws_region }}" \
              -var "source_ami={{ SOURCE_AMI.stdout }}" \
              -var "backend_instance_type={{ backend_instance_type }}" \
              -var "ssh_username={{ ssh_username }}" \
              -var "ssh_interface={{ ssh_interface }}" \
              -var "vpc_id={{ VPC_ID }}" \
              -var "subnet_id={{ SUBNET_ID }}" \
              -var "db_host={{ DB_HOST }}" \
              -var "db_port={{ DB_PORT }}" \
              -var "db_user={{ DB_USER }}" \
              -var "db_name={{ DB_NAME }}" \
              -var "db_password={{ DB_PASSWORD }}" \
              -var "security_group_id={{ PACKER_SG_ID }}" \
              -var "s3_ssm_cw_instance_profile_name={{ s3_ssm_cw_instance_profile_name }}" \
              -var "db_secret_name={{ db_secret_name }}" \
              -var "bucket_name={{ bucket_name }}" \
              -var "volume_type={{ backend_volume_type }}" \
              -var "volume_size={{ backend_volume_size }}" \
              -var "backend_ami_name={{ backend_ami_name }}" \
              -var "environment={{ environment }}" \
              -var "server_key_name={{ server_key_name.stdout }}" \
              -var "key_file_path={{ key_file_path }}" \
              {{ packer_template }} | tee >(grep -Eo 'ami-[a-z0-9]{17}' | tail -n1 > {{ ami_output_dir }}/backend_ami.txt)

          args:
            chdir: "{{ playbook_dir }}"
            executable: /bin/bash
          register: build_result
          timeout: 1800 # 30 minutes timeout
          # failed_when: false

        # - name: Check if build succeeded
        #   ansible.builtin.fail:
        #     msg: "Packer build failed with exit code {{ build_result.rc }}"
        #   when: build_result.rc != 0

        - name: Verify AMI ID was captured
          ansible.builtin.stat:
            path: "{{ ami_output_dir }}/backend_ami.txt"
          register: ami_file
          failed_when: not ami_file.stat.exists

        - name: Display saved AMI ID
          ansible.builtin.shell: cat {{ ami_output_dir }}/backend_ami.txt
          register: ami_id_value
          changed_when: false

        - name: Normalize AMI id into scalar
          ansible.builtin.set_fact:
            ami_id: "{{ ami_id_value.stdout | default('') | trim }}"

        - name: Show final AMI ID
          debug:
            # msg: "âœ… Backend AMI successfully built and saved: {{ ami_id.stdout }}"
            msg: "âœ… Backend AMI successfully built and saved: {{ ami_id }}"

      rescue:
        - name: Capture error details
          ansible.builtin.set_fact:
            build_failed: true
            error_message: "Build process failed with exit code {{ build_result.rc | default('unknown') }}"

        - name: Display build error
          ansible.builtin.debug:
            msg: |
              âŒ Packer build failed
              Error: {{ error_message }}

        # - name: Make Packer log human readable by remove ANSI escape sequences
        #   ansible.builtin.shell: |
        #     # After packer finishes, clean up the log
        #       cp "{{ clean_packer_log_path }}" "{{ clean_packer_log_path }}.bak"   # Backup raw log

        #       # Strip ANSI escape sequences
        #       sed -E 's/\x1b\[[0-9;]*m//g' "{{ clean_packer_log_path }}.bak" > "{{ clean_packer_log_path }}"

        #       # remove the backup raw file
        #       rm -f "{{ clean_packer_log_path }}.bak"
        #   changed_when: false
        #   ignore_errors: no

        - name: make packer log human readable by remove ANSI escape sequences in rescue via handler
          ansible.builtin.debug:
            msg: "Making Packer log human readable by removing ANSI escape sequences..."
          changed_when: true
          notify: modify_packer_log_file # â† This notifies the handler
          when: not log_file_modified | bool

        - name: set log file modified fact in rescue block
          ansible.builtin.set_fact:
            log_file_modified: true
          when: not log_file_modified | bool

        - name: Ensure packer log modificatio runs immediately to display last 100 lines
          ansible.builtin.meta: flush_handlers

        - name: Display last 100 lines of Packer log
          ansible.builtin.shell: |
            if [ -f "{{ clean_packer_log_path }}" ]; then
              echo "ğŸ“‹ Last 100 lines of Packer log:"
              tail -n 100 "{{ clean_packer_log_path }}"
            else
              echo "Log file not found at {{ clean_packer_log_path }}"
            fi
          register: packer_log_output # Capture stdout/stderr here
          changed_when: false
          ignore_errors: yes

        - name: Pretty print Packer log output
          ansible.builtin.debug:
            # msg: "{{ packer_log_output.stdout | to_nice_yaml }}"
            msg: "{{ packer_log_output.stdout_lines }}" # Prints as indented list
          when: packer_log_output is succeeded or packer_log_output is failed # Always show, even on error

        - name: check and delete partially created ami and snapshots
          ansible.builtin.debug:
            msg: "checking for partial AMI to delete..."
          changed_when: true
          notify: delete_ami # â† This notifies the handler

          # call cleanup from rescue
        - name: Trigger cleanup handler from rescue
          ansible.builtin.debug:
            msg: "Triggering cleanup..."
          changed_when: true
          notify: cleanup_resources # â† This notifies the handler
          when: not cleanup_done | bool

      always:
        # only run if not already done in rescue
        - name: Trigger cleanup handler from always
          ansible.builtin.debug:
            msg: "Triggering cleanup..."
          changed_when: true
          when: not cleanup_done | bool
          notify: cleanup_resources # â† This notifies the handler

        - name: Ensure cleanup runs
          ansible.builtin.meta: flush_handlers

        - name: make packer log human readable by remove ANSI escape sequences in rescue via handler
          ansible.builtin.debug:
            msg: "Making Packer log human readable by removing ANSI escape sequences..."
          changed_when: true
          notify: modify_packer_log_file # â† This notifies the handler
          when: not log_file_modified | bool

  handlers:
    - name: cleanup_resources
      ansible.builtin.include_tasks: "{{ playbook_dir }}/ansible_tasks/cleanup_tasks.yml"
      # ansible.builtin.include_tasks: cleanup_tasks.yml
      # when: not cleanup_done | bool
      listen: cleanup_resources

    - name: delete_ami
      ansible.builtin.include_tasks: "{{ playbook_dir }}/ansible_tasks/delete_ami.yml"
      # ansible.builtin.include_tasks: delete_ami.yml
      # when: not delete_done | bool
      listen: delete_ami
      # vars:
      #   aws_region: "{{ aws_region }}"
      #   ami_output_dir: "{{ ami_output_dir }}"

      # run this only if not already done in rescue
    - name: Make Packer log human readable by remove ANSI escape sequences
      ansible.builtin.shell: |
        # After packer finishes, clean up the log
        cp "{{ clean_packer_log_path }}" "{{ clean_packer_log_path }}.bak"   # Backup raw log

        # Strip ANSI escape sequences
        sed -E 's/\x1b\[[0-9;]*m//g' "{{ clean_packer_log_path }}.bak" > "{{ clean_packer_log_path }}"

        # remove the backup raw file
        rm -f "{{ clean_packer_log_path }}.bak"
      args:
        executable: /bin/bash
        chdir: "{{ playbook_dir }}"
      changed_when: false
      ignore_errors: no
      listen: modify_packer_log_file

  post_tasks:
    - name: Build Summary
      ansible.builtin.debug:
        msg: |
          ğŸ“Š Build Summary:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Build Status: {% if build_failed %}âŒ FAILED{% else %}âœ… SUCCESS{% endif %}
          {% if build_failed %}Error: {{ error_message }}{% endif %}
          {% if not build_failed and ami_id is defined %}AMI ID: {{ ami_id }}{% endif %}
          Packer Log: {{ clean_packer_log_path }}
          Packer SG: {{ PACKER_SG_ID | default('N/A') }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Final validation - exit if build failed
      ansible.builtin.fail:
        msg: "Build failed. Check logs above for details."
      when: build_failed | bool
